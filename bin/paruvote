#!/bin/bash
# vi: ft=sh

aur_voted() {
	local O=$((0))
	local PP=$((50))
	while :; do
		curl -sSL --cookie "/var/tmp/aurvote-$USER.cookie" "https://aur.archlinux.org/packages/?SB=w&SO=d&O=$O&PP=$PP&do_Search=Go" |
			hq 'tbody > tr' text |
			awk '{ if ($5 == "Yes") { print $1 } else { exit 1 } }' ||
			break
		O=$((O + PP))
	done
}

aur_installed() {
	pacman -Qqm | paru -Ta -
}

while getopts 'uvc' o; do
	case $o in
	u)
		grep -Fxvf <(aur_installed) <(aur_voted) | parallel aurvote -u
		;;
	v)
		grep -Fxvf <(aur_voted) <(aur_installed) | parallel aurvote -v
		;;
	*) exit 1 ;;
	esac
done
